const PlayerWrapper=function(player,adsPluginSettings,controller){this.vjsPlayer=player;this.controller=controller;this.contentTrackingTimer=null;this.contentComplete=false;this.updateTimeIntervalHandle=null;this.updateTimeInterval=1000;this.seekCheckIntervalHandle=null;this.seekCheckInterval=1000;this.resizeCheckIntervalHandle=null;this.resizeCheckInterval=250;this.seekThreshold=100;this.contentEndedListeners=[];this.contentSource='';this.contentSourceType='';this.contentPlayheadTracker={currentTime:0,previousTime:0,seeking:false,duration:0,};this.vjsPlayerDimensions={width:this.getPlayerWidth(),height:this.getPlayerHeight(),};this.vjsControls=this.vjsPlayer.getChild('controlBar');this.h5Player=null;this.vjsPlayer.one('play',this.setUpPlayerIntervals.bind(this));this.boundContentEndedListener=this.localContentEndedListener.bind(this);this.vjsPlayer.on('contentended',this.boundContentEndedListener);this.vjsPlayer.on('dispose',this.playerDisposedListener.bind(this));this.vjsPlayer.on('readyforpreroll',this.onReadyForPreroll.bind(this));this.vjsPlayer.ready(this.onPlayerReady.bind(this));this.vjsPlayer.ads(adsPluginSettings);};PlayerWrapper.prototype.setUpPlayerIntervals=function(){this.updateTimeIntervalHandle=setInterval(this.updateCurrentTime.bind(this),this.updateTimeInterval);this.seekCheckIntervalHandle=setInterval(this.checkForSeeking.bind(this),this.seekCheckInterval);this.resizeCheckIntervalHandle=setInterval(this.checkForResize.bind(this),this.resizeCheckInterval);};PlayerWrapper.prototype.updateCurrentTime=function(){if(!this.contentPlayheadTracker.seeking){this.contentPlayheadTracker.currentTime=this.vjsPlayer.currentTime();}};PlayerWrapper.prototype.checkForSeeking=function(){const tempCurrentTime=this.vjsPlayer.currentTime();const diff=(tempCurrentTime-this.contentPlayheadTracker.previousTime)*1000;if(Math.abs(diff)>this.seekCheckInterval+this.seekThreshold){this.contentPlayheadTracker.seeking=true;}else{this.contentPlayheadTracker.seeking=false;}
this.contentPlayheadTracker.previousTime=this.vjsPlayer.currentTime();};PlayerWrapper.prototype.checkForResize=function(){const currentWidth=this.getPlayerWidth();const currentHeight=this.getPlayerHeight();if(currentWidth!=this.vjsPlayerDimensions.width||currentHeight!=this.vjsPlayerDimensions.height){this.vjsPlayerDimensions.width=currentWidth;this.vjsPlayerDimensions.height=currentHeight;this.controller.onPlayerResize(currentWidth,currentHeight);}};PlayerWrapper.prototype.localContentEndedListener=function(){if(!this.contentComplete){this.contentComplete=true;this.controller.onContentComplete();}
for(let index in this.contentEndedListeners){if(typeof this.contentEndedListeners[index]==='function'){this.contentEndedListeners[index]();}}
clearInterval(this.updateTimeIntervalHandle);clearInterval(this.seekCheckIntervalHandle);clearInterval(this.resizeCheckIntervalHandle);if(this.vjsPlayer.el()){this.vjsPlayer.one('play',this.setUpPlayerIntervals.bind(this));}};PlayerWrapper.prototype.onNoPostroll=function(){this.vjsPlayer.trigger('nopostroll');};PlayerWrapper.prototype.playerDisposedListener=function(){this.contentEndedListeners=[];this.controller.onPlayerDisposed();this.contentComplete=true;this.vjsPlayer.off('contentended',this.boundContentEndedListener);if(this.vjsPlayer.ads.adTimeoutTimeout){clearTimeout(this.vjsPlayer.ads.adTimeoutTimeout);}
const intervalsToClear=[this.updateTimeIntervalHandle,this.seekCheckIntervalHandle,this.resizeCheckIntervalHandle];for(let index in intervalsToClear){if(intervalsToClear[index]){clearInterval(intervalsToClear[index]);}}};PlayerWrapper.prototype.onReadyForPreroll=function(){this.controller.onPlayerReadyForPreroll();};PlayerWrapper.prototype.onPlayerReady=function(){this.h5Player=document.getElementById(this.getPlayerId()).getElementsByClassName('vjs-tech')[0];if(this.h5Player.hasAttribute('autoplay')){this.controller.setSetting('adWillAutoPlay',true);}
this.onVolumeChange();this.vjsPlayer.on('fullscreenchange',this.onFullscreenChange.bind(this));this.vjsPlayer.on('volumechange',this.onVolumeChange.bind(this));this.controller.onPlayerReady();};PlayerWrapper.prototype.onFullscreenChange=function(){if(this.vjsPlayer.isFullscreen()){this.controller.onPlayerEnterFullscreen();}else{this.controller.onPlayerExitFullscreen();}};PlayerWrapper.prototype.onVolumeChange=function(){const newVolume=this.vjsPlayer.muted()?0:this.vjsPlayer.volume();this.controller.onPlayerVolumeChanged(newVolume);};PlayerWrapper.prototype.injectAdContainerDiv=function(adContainerDiv){this.vjsControls.el().parentNode.appendChild(adContainerDiv);};PlayerWrapper.prototype.getContentPlayer=function(){return this.h5Player;};PlayerWrapper.prototype.getVolume=function(){return this.vjsPlayer.muted()?0:this.vjsPlayer.volume();};PlayerWrapper.prototype.setVolume=function(volume){this.vjsPlayer.volume(volume);if(volume==0){this.vjsPlayer.muted(true);}else{this.vjsPlayer.muted(false);}};PlayerWrapper.prototype.unmute=function(){this.vjsPlayer.muted(false);};PlayerWrapper.prototype.mute=function(){this.vjsPlayer.muted(true);};PlayerWrapper.prototype.play=function(){this.vjsPlayer.play();};PlayerWrapper.prototype.getPlayerWidth=function(){let width=(getComputedStyle(this.vjsPlayer.el())||{}).width;if(!width||parseInt(width,10)===0){width=(this.vjsPlayer.el().getBoundingClientRect()||{}).width;}
return parseInt(width,10)||this.vjsPlayer.width();};PlayerWrapper.prototype.getPlayerHeight=function(){let height=(getComputedStyle(this.vjsPlayer.el())||{}).height;if(!height||parseInt(height,10)===0){height=(this.vjsPlayer.el().getBoundingClientRect()||{}).height;}
return parseInt(height,10)||this.vjsPlayer.height();};PlayerWrapper.prototype.getPlayerOptions=function(){return this.vjsPlayer.options_;};PlayerWrapper.prototype.getPlayerId=function(){return this.vjsPlayer.id();};PlayerWrapper.prototype.toggleFullscreen=function(){if(this.vjsPlayer.isFullscreen()){this.vjsPlayer.exitFullscreen();}else{this.vjsPlayer.requestFullscreen();}};PlayerWrapper.prototype.getContentPlayheadTracker=function(){return this.contentPlayheadTracker;};PlayerWrapper.prototype.onAdError=function(adErrorEvent){this.vjsControls.show();const errorMessage=adErrorEvent.getError!==undefined?adErrorEvent.getError():adErrorEvent.stack;this.vjsPlayer.trigger({type:'adserror',data:{AdError:errorMessage,AdErrorEvent:adErrorEvent,}});};PlayerWrapper.prototype.onAdLog=function(adEvent){const adData=adEvent.getAdData();const errorMessage=adData['adError']!==undefined?adData['adError'].getMessage():undefined;this.vjsPlayer.trigger({type:'adslog',data:{AdError:errorMessage,AdEvent:adEvent,}});};PlayerWrapper.prototype.onAdBreakStart=function(){this.contentSource=this.vjsPlayer.currentSrc();this.contentSourceType=this.vjsPlayer.currentType();this.vjsPlayer.off('contentended',this.boundContentEndedListener);this.vjsPlayer.ads.startLinearAdMode();this.vjsControls.hide();this.vjsPlayer.pause();};PlayerWrapper.prototype.onAdBreakEnd=function(){this.vjsPlayer.on('contentended',this.boundContentEndedListener);if(this.vjsPlayer.ads.inAdBreak()){this.vjsPlayer.ads.endLinearAdMode();}
this.vjsControls.show();};PlayerWrapper.prototype.onAdStart=function(){this.vjsPlayer.trigger('ads-ad-started');};PlayerWrapper.prototype.onAllAdsCompleted=function(){if(this.contentComplete==true){if(this.h5Player.src!=this.contentSource){this.vjsPlayer.autoplay(false);this.vjsPlayer.src({src:this.contentSource,type:this.contentSourceType,});}
this.controller.onContentAndAdsCompleted();}};PlayerWrapper.prototype.onAdsReady=function(){this.vjsPlayer.trigger('adsready');};PlayerWrapper.prototype.changeSource=function(contentSrc,playOnLoad){if(this.vjsPlayer.currentSrc()){this.vjsPlayer.currentTime(0);this.vjsPlayer.pause();}
if(contentSrc){this.vjsPlayer.src(contentSrc);}
if(playOnLoad){this.vjsPlayer.one('loadedmetadata',this.playContentFromZero.bind(this));}else{this.vjsPlayer.one('loadedmetadata',this.seekContentToZero.bind(this));}};PlayerWrapper.prototype.seekContentToZero=function(){this.vjsPlayer.currentTime(0);};PlayerWrapper.prototype.playContentFromZero=function(){this.vjsPlayer.currentTime(0);this.vjsPlayer.play();};PlayerWrapper.prototype.triggerPlayerEvent=function(name,data){this.vjsPlayer.trigger(name,data);};PlayerWrapper.prototype.addContentEndedListener=function(listener){this.contentEndedListeners.push(listener);};PlayerWrapper.prototype.reset=function(){this.vjsPlayer.on('contentended',this.boundContentEndedListener);this.vjsControls.show();if(this.vjsPlayer.ads.inAdBreak()){this.vjsPlayer.ads.endLinearAdMode();}
this.contentPlayheadTracker.currentTime=0;this.contentComplete=false;};export default PlayerWrapper;