import pkg from '../package.json';const SdkImpl=function(controller){this.controller=controller;this.adDisplayContainer=null;this.adDisplayContainerInitialized=false;this.adsLoader=null;this.adsManager=null;this.adsRenderingSettings=null;this.adsResponse=null;this.currentAd=null;this.adTrackingTimer=null;this.allAdsCompleted=false;this.adsActive=false;this.adPlaying=false;this.adMuted=false;this.adBreakReadyListener=undefined;this.contentCompleteCalled=false;this.adsManagerDimensions={width:0,height:0,};this.autoPlayAdBreaks=true;if(this.controller.getSettings().autoPlayAdBreaks===false){this.autoPlayAdBreaks=false;}
if(this.controller.getSettings().locale){google.ima.settings.setLocale(this.controller.getSettings().locale);}
if(this.controller.getSettings().disableFlashAds){google.ima.settings.setDisableFlashAds(this.controller.getSettings().disableFlashAds);}
if(this.controller.getSettings().disableCustomPlaybackForIOS10Plus){google.ima.settings.setDisableCustomPlaybackForIOS10Plus(this.controller.getSettings().disableCustomPlaybackForIOS10Plus);}};SdkImpl.prototype.initAdObjects=function(){this.adDisplayContainer=new google.ima.AdDisplayContainer(this.controller.getAdContainerDiv(),this.controller.getContentPlayer());this.adsLoader=new google.ima.AdsLoader(this.adDisplayContainer);this.adsLoader.getSettings().setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.ENABLED);if(this.controller.getSettings().vpaidAllowed==false){this.adsLoader.getSettings().setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.DISABLED);}
if(this.controller.getSettings().vpaidMode){this.adsLoader.getSettings().setVpaidMode(this.controller.getSettings().vpaidMode);}
if(this.controller.getSettings().locale){this.adsLoader.getSettings().setLocale(this.controller.getSettings().locale);}
if(this.controller.getSettings().numRedirects){this.adsLoader.getSettings().setNumRedirects(this.controller.getSettings().numRedirects);}
this.adsLoader.getSettings().setPlayerType('videojs-ima');this.adsLoader.getSettings().setPlayerVersion(pkg.version);this.adsLoader.getSettings().setAutoPlayAdBreaks(this.autoPlayAdBreaks);this.adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,this.onAdsManagerLoaded.bind(this),false);this.adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,this.onAdsLoaderError.bind(this),false);};SdkImpl.prototype.requestAds=function(){const adsRequest=new google.ima.AdsRequest();if(this.controller.getSettings().adTagUrl){adsRequest.adTagUrl=this.controller.getSettings().adTagUrl;}else{adsRequest.adsResponse=this.controller.getSettings().adsResponse;}
if(this.controller.getSettings().forceNonLinearFullSlot){adsRequest.forceNonLinearFullSlot=true;}
if(this.controller.getSettings().vastLoadTimeout){adsRequest.vastLoadTimeout=this.controller.getSettings().vastLoadTimeout;}
adsRequest.linearAdSlotWidth=this.controller.getPlayerWidth();adsRequest.linearAdSlotHeight=this.controller.getPlayerHeight();adsRequest.nonLinearAdSlotWidth=this.controller.getSettings().nonLinearWidth||this.controller.getPlayerWidth();adsRequest.nonLinearAdSlotHeight=this.controller.getSettings().nonLinearHeight||this.controller.getPlayerHeight();adsRequest.setAdWillAutoPlay(this.controller.adsWillAutoplay());adsRequest.setAdWillPlayMuted(this.controller.adsWillPlayMuted());let providedAdsRequest=this.controller.getSettings().adsRequest;if(providedAdsRequest&&typeof providedAdsRequest==='object'){Object.keys(providedAdsRequest).forEach((key)=>{adsRequest[key]=providedAdsRequest[key];});}
this.adsLoader.requestAds(adsRequest);this.controller.triggerPlayerEvent('ads-request',adsRequest);};SdkImpl.prototype.onAdsManagerLoaded=function(adsManagerLoadedEvent){this.createAdsRenderingSettings();this.adsManager=adsManagerLoadedEvent.getAdsManager(this.controller.getContentPlayheadTracker(),this.adsRenderingSettings);this.adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,this.onAdError.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.AD_BREAK_READY,this.onAdBreakReady.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,this.onContentPauseRequested.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,this.onContentResumeRequested.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,this.onAllAdsCompleted.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.LOADED,this.onAdLoaded.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.STARTED,this.onAdStarted.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.CLICK,this.onAdPaused.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE,this.onAdComplete.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPED,this.onAdComplete.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.LOG,this.onAdLog.bind(this));if(this.controller.getIsMobile()){this.adsManager.addEventListener(google.ima.AdEvent.Type.PAUSED,this.onAdPaused.bind(this));this.adsManager.addEventListener(google.ima.AdEvent.Type.RESUMED,this.onAdResumed.bind(this));}
if(!this.autoPlayAdBreaks){this.initAdsManager();}
this.controller.onAdsReady();if(this.controller.getSettings().adsManagerLoadedCallback){this.controller.getSettings().adsManagerLoadedCallback();}};SdkImpl.prototype.onAdsLoaderError=function(event){window.console.warn('AdsLoader error: '+event.getError());this.controller.onErrorLoadingAds(event);if(this.adsManager){this.adsManager.destroy();}};SdkImpl.prototype.initAdsManager=function(){try{const initWidth=this.controller.getPlayerWidth();const initHeight=this.controller.getPlayerHeight();this.adsManagerDimensions.width=initWidth;this.adsManagerDimensions.height=initHeight;this.adsManager.init(initWidth,initHeight,google.ima.ViewMode.NORMAL);this.adsManager.setVolume(this.controller.getPlayerVolume());if(!this.adDisplayContainerInitialized){this.adDisplayContainer.initialize();this.adDisplayContainer.initialized=true;}}catch(adError){this.onAdError(adError);}};SdkImpl.prototype.createAdsRenderingSettings=function(){this.adsRenderingSettings=new google.ima.AdsRenderingSettings();this.adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete=true;if(this.controller.getSettings().adsRenderingSettings){for(let setting in this.controller.getSettings().adsRenderingSettings){if(setting!==''){this.adsRenderingSettings[setting]=this.controller.getSettings().adsRenderingSettings[setting];}}}};SdkImpl.prototype.onAdError=function(adErrorEvent){const errorMessage=adErrorEvent.getError!==undefined?adErrorEvent.getError():adErrorEvent.stack;window.console.warn('Ad error: '+errorMessage);this.adsManager.destroy();this.controller.onAdError(adErrorEvent);this.adsActive=false;this.adPlaying=false;};SdkImpl.prototype.onAdBreakReady=function(adEvent){this.adBreakReadyListener(adEvent);};SdkImpl.prototype.onContentPauseRequested=function(adEvent){this.adsActive=true;this.adPlaying=true;this.controller.onAdBreakStart(adEvent);};SdkImpl.prototype.onContentResumeRequested=function(adEvent){this.adsActive=false;this.adPlaying=false;this.controller.onAdBreakEnd();};SdkImpl.prototype.onAllAdsCompleted=function(adEvent){this.allAdsCompleted=true;this.controller.onAllAdsCompleted();};SdkImpl.prototype.onAdLoaded=function(adEvent){if(!adEvent.getAd().isLinear()){this.controller.onNonLinearAdLoad();this.controller.playContent();}};SdkImpl.prototype.onAdStarted=function(adEvent){this.currentAd=adEvent.getAd();if(this.currentAd.isLinear()){this.adTrackingTimer=setInterval(this.onAdPlayheadTrackerInterval.bind(this),250);this.controller.onLinearAdStart();}else{this.controller.onNonLinearAdStart();}};SdkImpl.prototype.onAdPaused=function(){this.controller.onAdsPaused();};SdkImpl.prototype.onAdResumed=function(adEvent){this.controller.onAdsResumed();};SdkImpl.prototype.onAdComplete=function(){if(this.currentAd.isLinear()){clearInterval(this.adTrackingTimer);}};SdkImpl.prototype.onAdLog=function(adEvent){this.controller.onAdLog(adEvent);};SdkImpl.prototype.onAdPlayheadTrackerInterval=function(){const remainingTime=this.adsManager.getRemainingTime();const duration=this.currentAd.getDuration();let currentTime=duration-remainingTime;currentTime=currentTime>0?currentTime:0;let totalAds=0;let adPosition;if(this.currentAd.getAdPodInfo()){adPosition=this.currentAd.getAdPodInfo().getAdPosition();totalAds=this.currentAd.getAdPodInfo().getTotalAds();}
this.controller.onAdPlayheadUpdated(currentTime,remainingTime,duration,adPosition,totalAds);};SdkImpl.prototype.onContentComplete=function(){if(this.adsLoader){this.adsLoader.contentComplete();this.contentCompleteCalled=true;}
if(this.adsManager&&this.adsManager.getCuePoints()&&!this.adsManager.getCuePoints().includes(-1)){this.controller.onNoPostroll();}
if(this.allAdsCompleted){this.controller.onContentAndAdsCompleted();}};SdkImpl.prototype.onPlayerDisposed=function(){if(this.adTrackingTimer){clearInterval(this.adTrackingTimer);}
if(this.adsManager){this.adsManager.destroy();this.adsManager=null;}};SdkImpl.prototype.onPlayerReadyForPreroll=function(){if(this.autoPlayAdBreaks){this.initAdsManager();try{this.controller.showAdContainer();this.adsManager.setVolume(this.controller.getPlayerVolume());this.adsManager.start();}catch(adError){this.onAdError(adError);}}};SdkImpl.prototype.onPlayerReady=function(){this.initAdObjects();if(this.controller.getSettings().adTagUrl||this.controller.getSettings().adsResponse){this.requestAds();}};SdkImpl.prototype.onPlayerEnterFullscreen=function(){if(this.adsManager){this.adsManager.resize(window.screen.width,window.screen.height,google.ima.ViewMode.FULLSCREEN);}};SdkImpl.prototype.onPlayerExitFullscreen=function(){if(this.adsManager){this.adsManager.resize(this.controller.getPlayerWidth(),this.controller.getPlayerHeight(),google.ima.ViewMode.NORMAL);}};SdkImpl.prototype.onPlayerVolumeChanged=function(volume){if(this.adsManager){this.adsManager.setVolume(volume);}
if(volume==0){this.adMuted=true;}else{this.adMuted=false;}};SdkImpl.prototype.onPlayerResize=function(width,height){if(this.adsManager){this.adsManagerDimensions.width=width;this.adsManagerDimensions.height=height;this.adsManager.resize(width,height,google.ima.ViewMode.NORMAL);}};SdkImpl.prototype.getCurrentAd=function(){return this.currentAd;};SdkImpl.prototype.setAdBreakReadyListener=function(listener){this.adBreakReadyListener=listener;};SdkImpl.prototype.isAdPlaying=function(){return this.adPlaying;};SdkImpl.prototype.isAdMuted=function(){return this.adMuted;};SdkImpl.prototype.pauseAds=function(){this.adsManager.pause();this.adPlaying=false;};SdkImpl.prototype.resumeAds=function(){this.adsManager.resume();this.adPlaying=true;};SdkImpl.prototype.unmute=function(){this.adsManager.setVolume(1);this.adMuted=false;};SdkImpl.prototype.mute=function(){this.adsManager.setVolume(0);this.adMuted=true;};SdkImpl.prototype.setVolume=function(volume){this.adsManager.setVolume(volume);if(volume==0){this.adMuted=true;}else{this.adMuted=false;}};SdkImpl.prototype.initializeAdDisplayContainer=function(){if(this.adDisplayContainer){this.adDisplayContainerInitialized=true;this.adDisplayContainer.initialize();}};SdkImpl.prototype.playAdBreak=function(){if(!this.autoPlayAdBreaks){this.controller.showAdContainer();this.adsManager.setVolume(this.controller.getPlayerVolume());this.adsManager.start();}};SdkImpl.prototype.addEventListener=function(event,callback){if(this.adsManager){this.adsManager.addEventListener(event,callback);}};SdkImpl.prototype.getAdsManager=function(){return this.adsManager;};SdkImpl.prototype.reset=function(){this.adsActive=false;this.adPlaying=false;if(this.adTrackingTimer){clearInterval(this.adTrackingTimer);}
if(this.adsManager){this.adsManager.destroy();this.adsManager=null;}
if(this.adsLoader&&!this.contentCompleteCalled){this.adsLoader.contentComplete();}
this.contentCompleteCalled=false;this.allAdsCompleted=false;};export default SdkImpl;