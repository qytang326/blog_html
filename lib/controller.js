import PlayerWrapper from './player-wrapper.js';import AdUi from './ad-ui.js';import SdkImpl from './sdk-impl.js';const Controller=function(player,options){this.settings={};this.contentAndAdsEndedListeners=[];this.isMobile=(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i));this.isIos=(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i));this.initWithSettings(options);const contribAdsDefaults={debug:this.settings.debug,timeout:this.settings.timeout,prerollTimeout:this.settings.prerollTimeout,};const adsPluginSettings=this.extend({},contribAdsDefaults,options.contribAdsSettings||{});this.playerWrapper=new PlayerWrapper(player,adsPluginSettings,this);this.adUi=new AdUi(this);this.sdkImpl=new SdkImpl(this);};Controller.IMA_DEFAULTS={debug:false,timeout:5000,prerollTimeout:1000,adLabel:'Advertisement',adLabelNofN:'of',showControlsForJSAds:true,};Controller.prototype.initWithSettings=function(options){this.settings=this.extend({},Controller.IMA_DEFAULTS,options||{});this.warnAboutDeprecatedSettings();this.showCountdown=true;if(this.settings.showCountdown===false){this.showCountdown=false;}};Controller.prototype.warnAboutDeprecatedSettings=function(){const deprecatedSettings=['adWillAutoplay','adsWillAutoplay','adWillPlayMuted','adsWillPlayMuted',];deprecatedSettings.forEach((setting)=>{if(this.settings[setting]!==undefined){console.warn('WARNING: videojs.ima setting '+setting+' is deprecated');}});};Controller.prototype.getSettings=function(){return this.settings;};Controller.prototype.getIsMobile=function(){return this.isMobile;};Controller.prototype.getIsIos=function(){return this.isIos;};Controller.prototype.injectAdContainerDiv=function(adContainerDiv){this.playerWrapper.injectAdContainerDiv(adContainerDiv);};Controller.prototype.getAdContainerDiv=function(){return this.adUi.getAdContainerDiv();};Controller.prototype.getContentPlayer=function(){return this.playerWrapper.getContentPlayer();};Controller.prototype.getContentPlayheadTracker=function(){return this.playerWrapper.getContentPlayheadTracker();};Controller.prototype.requestAds=function(){this.sdkImpl.requestAds();};Controller.prototype.setSetting=function(key,value){this.settings[key]=value;};Controller.prototype.onErrorLoadingAds=function(adErrorEvent){this.adUi.onAdError();this.playerWrapper.onAdError(adErrorEvent);};Controller.prototype.onAdPlayPauseClick=function(){if(this.sdkImpl.isAdPlaying()){this.adUi.onAdsPaused();this.sdkImpl.pauseAds();}else{this.adUi.onAdsPlaying();this.sdkImpl.resumeAds();}};Controller.prototype.onAdMuteClick=function(){if(this.sdkImpl.isAdMuted()){this.playerWrapper.unmute();this.adUi.unmute();this.sdkImpl.unmute();}else{this.playerWrapper.mute();this.adUi.mute();this.sdkImpl.mute();}};Controller.prototype.setVolume=function(volume){this.playerWrapper.setVolume(volume);this.sdkImpl.setVolume(volume);};Controller.prototype.getPlayerVolume=function(){return this.playerWrapper.getVolume();};Controller.prototype.toggleFullscreen=function(){this.playerWrapper.toggleFullscreen();};Controller.prototype.onAdError=function(adErrorEvent){this.adUi.onAdError();this.playerWrapper.onAdError(adErrorEvent);};Controller.prototype.onAdBreakStart=function(adEvent){this.playerWrapper.onAdBreakStart();this.adUi.onAdBreakStart(adEvent);};Controller.prototype.showAdContainer=function(){this.adUi.showAdContainer();};Controller.prototype.onAdBreakEnd=function(){this.playerWrapper.onAdBreakEnd();this.adUi.onAdBreakEnd();};Controller.prototype.onAllAdsCompleted=function(){this.adUi.onAllAdsCompleted();this.playerWrapper.onAllAdsCompleted();};Controller.prototype.onAdsPaused=function(){this.adUi.onAdsPaused();};Controller.prototype.onAdsResumed=function(){this.adUi.onAdsResumed();};Controller.prototype.onAdPlayheadUpdated=function(currentTime,remainingTime,duration,adPosition,totalAds){this.adUi.updateAdUi(currentTime,remainingTime,duration,adPosition,totalAds);};Controller.prototype.onAdLog=function(adEvent){this.playerWrapper.onAdLog(adEvent);};Controller.prototype.getCurrentAd=function(){return this.sdkImpl.getCurrentAd();};Controller.prototype.playContent=function(){this.playerWrapper.play();};Controller.prototype.onLinearAdStart=function(){this.adUi.onLinearAdStart();this.playerWrapper.onAdStart();};Controller.prototype.onNonLinearAdLoad=function(){this.adUi.onNonLinearAdLoad();};Controller.prototype.onNonLinearAdStart=function(){this.adUi.onNonLinearAdLoad();this.playerWrapper.onAdStart();};Controller.prototype.getPlayerWidth=function(){return this.playerWrapper.getPlayerWidth();};Controller.prototype.getPlayerHeight=function(){return this.playerWrapper.getPlayerHeight();};Controller.prototype.onAdsReady=function(){this.playerWrapper.onAdsReady();};Controller.prototype.onPlayerResize=function(width,height){this.sdkImpl.onPlayerResize(width,height);};Controller.prototype.onContentComplete=function(){this.sdkImpl.onContentComplete();};Controller.prototype.onNoPostroll=function(){this.playerWrapper.onNoPostroll();};Controller.prototype.onContentAndAdsCompleted=function(){for(let index in this.contentAndAdsEndedListeners){if(typeof this.contentAndAdsEndedListeners[index]==='function'){this.contentAndAdsEndedListeners[index]();}}};Controller.prototype.onPlayerDisposed=function(){this.contentAndAdsEndedListeners=[];this.sdkImpl.onPlayerDisposed();};Controller.prototype.onPlayerReadyForPreroll=function(){this.sdkImpl.onPlayerReadyForPreroll();};Controller.prototype.onPlayerReady=function(){this.sdkImpl.onPlayerReady();};Controller.prototype.onPlayerEnterFullscreen=function(){this.adUi.onPlayerEnterFullscreen();this.sdkImpl.onPlayerEnterFullscreen();};Controller.prototype.onPlayerExitFullscreen=function(){this.adUi.onPlayerExitFullscreen();this.sdkImpl.onPlayerExitFullscreen();};Controller.prototype.onPlayerVolumeChanged=function(volume){this.adUi.onPlayerVolumeChanged(volume);this.sdkImpl.onPlayerVolumeChanged(volume);};Controller.prototype.setContentWithAdTag=function(contentSrc,adTag,playOnLoad){this.reset();this.settings.adTagUrl=adTag?adTag:this.settings.adTagUrl;this.playerWrapper.changeSource(contentSrc,playOnLoad);};Controller.prototype.setContentWithAdsResponse=function(contentSrc,adsResponse,playOnLoad){this.reset();this.settings.adsResponse=adsResponse?adsResponse:this.settings.adsResponse;this.playerWrapper.changeSource(contentSrc,playOnLoad);};Controller.prototype.setContentWithAdsRequest=function(contentSrc,adsRequest,playOnLoad){this.reset();this.settings.adsRequest=adsRequest?adsRequest:this.settings.adsRequest;this.playerWrapper.changeSource(contentSrc,playOnLoad);};Controller.prototype.reset=function(){this.sdkImpl.reset();this.playerWrapper.reset();};Controller.prototype.addContentEndedListener=function(listener){this.playerWrapper.addContentEndedListener(listener);};Controller.prototype.addContentAndAdsEndedListener=function(listener){this.contentAndAdsEndedListeners.push(listener);};Controller.prototype.setAdBreakReadyListener=function(listener){this.sdkImpl.setAdBreakReadyListener(listener);};Controller.prototype.setShowCountdown=function(showCountdownIn){this.adUi.setShowCountdown(showCountdownIn);this.showCountdown=showCountdownIn;this.countdownDiv.style.display=this.showCountdown?'block':'none';};Controller.prototype.initializeAdDisplayContainer=function(){this.sdkImpl.initializeAdDisplayContainer();};Controller.prototype.playAdBreak=function(){this.sdkImpl.playAdBreak();};Controller.prototype.addEventListener=function(event,callback){this.sdkImpl.addEventListener(event,callback);};Controller.prototype.getAdsManager=function(){return this.sdkImpl.getAdsManager();};Controller.prototype.getPlayerId=function(){return this.playerWrapper.getPlayerId();};Controller.prototype.changeAdTag=function(adTag){this.reset();this.settings.adTagUrl=adTag;};Controller.prototype.pauseAd=function(){this.adUi.onAdsPaused();this.sdkImpl.pauseAds();};Controller.prototype.resumeAd=function(){this.adUi.onAdsPlaying();this.sdkImpl.resumeAds();};Controller.prototype.adsWillAutoplay=function(){if(this.settings.adsWillAutoplay!==undefined){return this.settings.adsWillAutoplay;}else if(this.settings.adWillAutoplay!==undefined){return this.settings.adWillAutoplay;}else{return!!this.playerWrapper.getPlayerOptions().autoplay;}};Controller.prototype.adsWillPlayMuted=function(){if(this.settings.adsWillPlayMuted!==undefined){return this.settings.adsWillPlayMuted;}else if(this.settings.adWillPlayMuted!==undefined){return this.settings.adWillPlayMuted;}else if(this.playerWrapper.getPlayerOptions().muted!==undefined){return this.playerWrapper.getPlayerOptions().muted;}else{return this.playerWrapper.getVolume()==0;}};Controller.prototype.triggerPlayerEvent=function(name,data){this.playerWrapper.triggerPlayerEvent(name,data);};Controller.prototype.extend=function(obj,...args){let arg;let index;let key;for(index=0;index<args.length;index++){arg=args[index];for(key in arg){if(arg.hasOwnProperty(key)){obj[key]=arg[key];}}}
return obj;};export default Controller;